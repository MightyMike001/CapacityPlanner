<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Motrac â€¢ High Design Template</title>
  <meta name="color-scheme" content="dark light">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1115;
      --bg-2:#161b22;
      --gloss:#161b22;
      --panel:#161b22;
      --panel-2:#1c222d;
      --stroke:rgba(148,163,184,.12);
      --stroke-2:rgba(148,163,184,.2);
      --text:#f2f4f8;
      --muted:#9aa6ba;
      --accent:#ef4444;
      --accent-2:#dc2626;
      --ok:#22c55e;
      --warn:#facc15;
      --danger:#f87171;
      --chip:#1d2430;
      --focus:#f59e0b;
      --shadow:none;
      --radius:12px;
      --leave-vakantie:#16a34a;
      --leave-verlof:#0ea5e9;
      --leave-ziek:#f43f5e;
      --leave-training:#a855f7;
      --leave-thuis:#f97316;
      --leave-feestdag:#eab308;
      --leave-deeltijd:#64748b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:var(--bg);
      overflow-x:hidden;
    }

    /* Layout */
    .app{
      display:grid;
      grid-template-columns: 280px 1fr;
      grid-template-rows: 64px 1fr;
      grid-template-areas:
        "nav nav"
        "side main";
      min-height:100vh;
    }

    /* Top Nav */
    .nav{
      grid-area:nav;
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 18px;
      background:var(--panel);
      border-bottom:1px solid var(--stroke);
      position:sticky; top:0; z-index:50;
    }
    .brand{
      display:flex; gap:12px; align-items:center;
    }
    .brand .logo{
      width:40px;height:40px;border-radius:12px;
      background:var(--accent);
      display:grid;place-items:center;font-weight:700;
    }
    .brand .title{font-weight:700; letter-spacing:.2px}
    .nav .actions{display:flex; gap:8px}
    .btn{
      appearance:none; border:none; cursor:pointer;
      padding:10px 14px; border-radius:10px;
      background:var(--accent);
      color:white; font-weight:600;
      font:inherit;
      transition:background .2s ease, transform .2s ease;
    }
    .btn:hover{transform:translateY(-1px);}
    .btn.secondary{background:transparent;border:1px solid var(--stroke);color:var(--text)}
    .btn.secondary:hover{background:var(--panel-2);}
    .btn.ghost{background:transparent;border:1px solid var(--stroke);color:var(--text)}
    .btn.ghost:hover{background:var(--panel-2);}
    .btn.small{padding:8px 10px;font-size:12px}

    /* Sidebar */
    .side{
      grid-area:side;
      padding:18px;
      background:var(--bg);
      border-right:1px solid var(--stroke);
      position:sticky; top:64px; height:calc(100vh - 64px);
      overflow:auto;
    }
    .panel{
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      padding:14px;
      margin-bottom:14px;
    }
    .panel h3{margin:0 0 10px; font-size:14px; color:#eaeef5; letter-spacing:.3px}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 8px}
    input,select{
      width:100%; padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--stroke);
      background:var(--bg-2); color:var(--text);
      outline:none;
      transition:border-color .2s ease, box-shadow .2s ease;
    }
    input:focus-visible,select:focus-visible{
      border-color:var(--focus);
      box-shadow:0 0 0 3px rgba(245,158,11,.35);
      outline:none;
    }

    .chips{display:flex; flex-wrap:wrap; gap:8px}
    .chip{
      background:var(--chip); border:1px solid var(--stroke);
      padding:6px 12px; border-radius:999px; font-size:12px; color:var(--muted);
      cursor:pointer;
      display:flex; gap:6px; align-items:center;
      font:inherit;
      line-height:1.2;
    }
    .chip span[aria-hidden="true"]{font-size:14px; line-height:1;}
    .chip .chip-label{overflow-wrap:anywhere;}

    /* Main */
    .main{
      grid-area:main;
      padding:18px;
      overflow:auto;
    }

    /* Hero */
    .hero{
      display:grid; grid-template-columns: 1.2fr .8fr; gap:18px; align-items:stretch;
      margin-bottom:18px;
    }
    .hero .card{
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      padding:18px;
    }
    .hero .card::after{display:none;}
    .hero h1{margin:0 0 8px; font-size:24px}
    .hero p{margin:0; color:var(--muted)}
    .cta-row{margin-top:14px; display:flex; gap:10px; flex-wrap:wrap}

    /* KPIs */
    .kpis{
      display:grid; grid-template-columns: repeat(4, 1fr); gap:12px;
    }
    .kpi{
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:14px; padding:14px;
    }
    .kpi .v{font-size:22px; font-weight:800}
    .kpi small{display:block; color:var(--muted)}
    .kpi.ok .v{color:var(--ok)}
    .kpi.warn .v{color:var(--warn)}
    .kpi.danger .v{color:var(--danger)}

    /* Cards grid */
    .grid{
      display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:14px;
      margin-top:16px;
    }
    .card{
      background:var(--panel);
      border:1px solid var(--stroke-2);
      border-radius:14px; padding:14px;
    }
    .card .top{display:flex; gap:8px; align-items:center; margin-bottom:6px}
    .badge{
      font-size:11px; border-radius:20px; padding:4px 8px;
      background:transparent; border:1px solid var(--stroke);
      color:var(--muted);
    }
    .badge.prio{color:var(--accent); border-color:rgba(239,68,68,.35);}
    .badge.skill{color:var(--leave-training); border-color:rgba(168,85,247,.35);}
    .badge.hours{color:var(--warn); border-color:rgba(250,204,21,.35);}
    .card h4{margin:6px 0 8px}
    .card .sub{color:var(--muted); font-size:12px}
    .card .row{display:flex; justify-content:space-between; align-items:center; margin-top:10px}
    .card .row .btn{width:auto; padding:8px 10px}

    /* Capacity chart */
    .capacity-chart{
      margin:14px 0 10px;
      background:var(--panel-2);
      border:1px solid var(--stroke);
      border-radius:12px;
      padding:12px;
      min-height:220px;
      display:flex;
      align-items:stretch;
      justify-content:center;
      position:relative;
    }
    .capacity-chart svg{width:100%; height:auto; display:block; flex:1 1 auto; aspect-ratio:860/280;}
    .capacity-chart__empty{font-size:13px; color:var(--muted); text-align:center; margin:auto;}
    .capacity-chart__legend{
      display:flex;
      gap:16px;
      align-items:center;
      font-size:12px;
      color:var(--muted);
      margin-top:6px;
    }
    .capacity-chart__grid{stroke:var(--stroke); stroke-width:1; opacity:.28;}
    .capacity-chart__tick{fill:var(--muted); font-size:11px; letter-spacing:.2px;}
    .capacity-chart__dot{stroke:var(--panel-2); stroke-width:1;}
    .capacity-chart__dot.capacity{fill:var(--accent);}
    .capacity-chart__dot.workload{fill:var(--ok);}
    .legend-dot{
      display:inline-flex;
      width:10px;
      height:10px;
      border-radius:50%;
      margin-right:6px;
    }
    .legend-dot--capacity{background:var(--accent);}
    .legend-dot--workload{background:var(--ok);}

    /* Tabs */
    .tabs{display:flex; gap:8px; margin:16px 0 8px; flex-wrap:wrap}
    .tab{
      padding:8px 12px; border-radius:10px;
      background:transparent; border:1px solid var(--stroke);
      cursor:pointer; user-select:none;
      color:var(--text);
      font:inherit;
    }
    .tab.active{background:var(--accent); color:#fff; border-color:var(--accent);}

    /* Table */
    .table-wrap{
      margin-top:16px; background:var(--panel); border:1px solid var(--stroke);
      border-radius:14px; overflow:auto;
    }
    table{width:100%; border-collapse:collapse; min-width:760px}
    thead th{
      position:sticky; top:0;
      background:var(--panel-2); color:#dbe3ee;
      text-align:left; font-size:12px; letter-spacing:.2px;
      border-bottom:1px solid var(--stroke);
      padding:10px;
    }
    tbody td{
      border-bottom:1px solid var(--stroke); padding:10px; font-size:13px;
    }
    tbody tr:hover{background:var(--panel-2)}

    /* Leave matrix */
    .leave-section{
      margin-top:24px;
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:var(--shadow);
    }
    .leave-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:16px;
      margin-bottom:16px;
    }
    .leave-header h2{
      margin:0;
      font-size:20px;
      letter-spacing:.2px;
    }
    .leave-header p{
      margin:6px 0 0;
      font-size:13px;
      color:var(--muted);
    }
    .leave-legend{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:center;
    }
    .legend-item{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:12px;
      color:var(--muted);
    }
    .legend-swatch{
      width:18px;
      height:18px;
      border-radius:6px;
      border:1px solid var(--stroke);
    }
    .leave-matrix-wrap{
      overflow:auto;
      border:1px solid var(--stroke);
      border-radius:12px;
    }
    .leave-matrix{
      border-collapse:separate;
      border-spacing:0;
      min-width:960px;
      width:100%;
    }
    .leave-matrix caption{
      caption-side:bottom;
      padding:12px 10px 0;
      font-size:12px;
      color:var(--muted);
      text-align:left;
    }
    .leave-matrix thead th{
      position:sticky;
      top:0;
      background:var(--panel-2);
      color:#dbe3ee;
      text-align:center;
      font-size:11px;
      letter-spacing:.2px;
      border-bottom:1px solid var(--stroke);
      border-right:1px solid var(--stroke);
      padding:10px 8px;
      z-index:5;
    }
    .leave-matrix thead th:first-child,
    .leave-matrix thead th:nth-child(2){
      text-align:left;
      z-index:6;
    }
    .leave-matrix thead th:first-child{left:0; position:sticky; width:200px; min-width:200px;}
    .leave-matrix thead th:nth-child(2){left:200px; position:sticky;}
    .leave-matrix thead tr:nth-child(1) th{top:0;}
    .leave-matrix thead tr:nth-child(2) th{top:36px;}
    .leave-matrix thead tr:nth-child(3) th{top:72px;}
    .leave-matrix thead th.month-group{font-size:12px; text-transform:capitalize;}
    .leave-matrix thead th.is-weekend,
    .leave-matrix tbody td.is-weekend{background:#0f141d; color:#9aa5b5;}
    .leave-matrix tbody th{
      position:sticky;
      left:0;
      text-align:left;
      font-size:13px;
      font-weight:600;
      color:#e3e8f1;
      background:var(--panel);
      border-bottom:1px solid var(--stroke);
      border-right:1px solid var(--stroke);
      padding:10px;
      z-index:4;
      min-width:200px;
      width:200px;
    }
    .leave-matrix tbody th .meta{
      display:block;
      color:var(--muted);
      font-size:11px;
      margin-top:2px;
    }
    .leave-matrix tbody tr:nth-child(even) th{background:var(--panel-2);}
    .leave-matrix tbody td.team{
      position:sticky;
      left:200px;
      text-align:left;
      background:var(--panel);
      color:var(--muted);
      font-size:12px;
      padding:10px;
      z-index:3;
      min-width:160px;
    }
    .leave-matrix tbody tr:nth-child(even) td.team{background:var(--panel-2);}
    .leave-matrix tbody td{
      border-bottom:1px solid var(--stroke);
      border-right:1px solid var(--stroke);
      padding:6px;
      font-size:12px;
      min-width:48px;
      text-align:center;
      vertical-align:middle;
      position:relative;
    }
    .leave-matrix tbody td .cell-stack{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:stretch;
    }
    .leave-input{
      width:100%;
      padding:6px 4px;
      border-radius:6px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(17,24,33,.6);
      color:var(--text);
      text-align:center;
      font-weight:600;
      font-size:12px;
      transition:border-color .2s ease, background .2s ease;
    }
    .leave-input::placeholder{color:rgba(255,255,255,.3);}
    .leave-input:focus-visible{
      outline:none;
      border-color:var(--focus);
      box-shadow:0 0 0 3px rgba(245,158,11,.25);
      background:rgba(245,158,11,.18);
    }
    .leave-matrix td.has-absence .leave-input{
      background:rgba(0,0,0,.18);
      border-color:rgba(255,255,255,.18);
      color:#fff;
    }
    .leave-reason{
      appearance:none;
      width:100%;
      padding:4px 6px;
      border-radius:6px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(17,24,33,.55);
      color:var(--muted);
      font-size:10px;
      letter-spacing:.3px;
      text-transform:uppercase;
      cursor:pointer;
      transition:border-color .2s ease, background .2s ease, color .2s ease;
    }
    .leave-reason:focus-visible{
      outline:none;
      border-color:var(--focus);
      box-shadow:0 0 0 3px rgba(245,158,11,.2);
      background:rgba(245,158,11,.15);
    }
    .leave-reason.is-hidden{display:none;}
    .leave-matrix td.has-absence{
      color:var(--text);
      box-shadow:inset 0 0 0 1px rgba(148,163,184,.18);
    }
    .leave-matrix td.has-absence .leave-reason{
      background:var(--panel-2);
      border-color:rgba(148,163,184,.3);
      color:var(--text);
    }
    .leave-matrix td.absence--vakantie{background:rgba(22,163,74,.18);}
    .leave-matrix td.absence--verlof{background:rgba(14,165,233,.16);}
    .leave-matrix td.absence--ziek{background:rgba(244,63,94,.18);}
    .leave-matrix td.absence--training{background:rgba(168,85,247,.16);}
    .leave-matrix td.absence--thuis{background:rgba(249,115,22,.16);}
    .leave-matrix td.absence--feestdag{background:rgba(234,179,8,.18);}
    .leave-matrix td.absence--deeltijd{background:rgba(100,116,139,.18);}
    .leave-tag{
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:8px;
      padding:6px 4px;
      font-size:11px;
      font-weight:600;
      letter-spacing:.3px;
      color:var(--muted);
      text-transform:uppercase;
      background:var(--panel-2);
      border:1px solid var(--stroke);
      min-width:34px;
    }
    .leave-tag--vakantie{color:var(--leave-vakantie); border-color:rgba(22,163,74,.35);}
    .leave-tag--verlof{color:var(--leave-verlof); border-color:rgba(14,165,233,.35);}
    .leave-tag--ziek{color:var(--leave-ziek); border-color:rgba(244,63,94,.35);}
    .leave-tag--training{color:var(--leave-training); border-color:rgba(168,85,247,.35);}
    .leave-tag--thuis{color:var(--leave-thuis); border-color:rgba(249,115,22,.35);}
    .leave-tag--feestdag{color:var(--leave-feestdag); border-color:rgba(234,179,8,.35);}
    .leave-tag--deeltijd{color:var(--leave-deeltijd); border-color:rgba(100,116,139,.35);}
    .leave-matrix td.empty{background:rgba(255,255,255,.02);}
    .leave-matrix td.is-weekend.empty{background:rgba(17,24,33,.7);}
    .leave-swatch--vakantie{background:rgba(22,163,74,.4); border-color:rgba(22,163,74,.55);}
    .leave-swatch--verlof{background:rgba(14,165,233,.4); border-color:rgba(14,165,233,.55);}
    .leave-swatch--ziek{background:rgba(244,63,94,.45); border-color:rgba(244,63,94,.6);}
    .leave-swatch--training{background:rgba(168,85,247,.4); border-color:rgba(168,85,247,.55);}
    .leave-swatch--thuis{background:rgba(249,115,22,.4); border-color:rgba(249,115,22,.55);}
    .leave-swatch--feestdag{background:rgba(234,179,8,.45); border-color:rgba(234,179,8,.6);}
    .leave-swatch--deeltijd{background:rgba(100,116,139,.4); border-color:rgba(100,116,139,.6);}

    /* Focus styles */
    .btn:focus-visible,
    .tab:focus-visible,
    .chip:focus-visible{
      outline:3px solid var(--focus);
      outline-offset:2px;
    }
    .btn:focus-visible{box-shadow:0 0 0 3px rgba(245,158,11,.35);}
    .tab:focus-visible{box-shadow:0 0 0 2px rgba(245,158,11,.25);}

    /* Responsive */
    @media (max-width: 1200px){
      .app{
        grid-template-columns: 240px 1fr;
      }
    }
    @media (max-width: 1024px){
      .app{
        grid-template-columns:1fr;
        grid-template-areas:
          "nav"
          "main"
          "side";
      }
      .side{
        position:relative;
        top:auto;
        height:auto;
        border-right:none;
        border-top:1px solid var(--stroke);
        padding-bottom:32px;
      }
      .main{padding:18px 18px 48px;}
    }
    @media (max-width: 900px){
      .hero{grid-template-columns:1fr;}
      .kpis{grid-template-columns:repeat(2,minmax(0,1fr));}
      table{min-width:0;}
    }
    @media (max-width: 640px){
      .app{grid-template-rows:auto;}
      .nav{flex-wrap:wrap; gap:12px;}
      .nav .actions{flex-wrap:wrap;}
      .side, .main{padding:16px;}
      table{min-width:0; display:block; width:100%;}
      .table-wrap{overflow:visible; background:transparent; border:none; box-shadow:none;}
      .table-wrap table{background:var(--panel); border:1px solid var(--stroke); border-radius:14px; overflow:hidden;}
      thead{border:0; clip:rect(0 0 0 0); height:1px; width:1px; margin:-1px; overflow:hidden; padding:0; position:absolute;}
      tbody{display:flex; flex-direction:column; gap:12px; margin:0; padding:0;}
      tbody tr{
        display:grid;
        grid-template-columns:repeat(2,minmax(0,1fr));
        gap:12px;
        border:1px solid var(--stroke);
        border-radius:12px;
        padding:14px;
        background:var(--panel);
      }
      tbody td{
        display:block;
        border:none;
        padding:0;
        font-size:14px;
        word-break:break-word;
      }
      tbody td::before{
        content:attr(data-label);
        display:block;
        font-size:12px;
        color:var(--muted);
        margin-bottom:4px;
      }
      tbody tr:hover{background:var(--panel);}
    }
    @media (max-width: 480px){
      .hero .card{padding:16px;}
      .cta-row{flex-direction:column; align-items:stretch;}
      .kpis{grid-template-columns:1fr;}
      tbody tr{grid-template-columns:1fr;}
    }

    /* Drawer / Modal */
    .drawer{
      position:fixed; inset:auto 0 0 auto; width:420px; height:100%;
      background:var(--panel-2); border-left:1px solid var(--stroke);
      transform: translateX(110%); transition: transform .25s ease;
      z-index:70; padding:16px;
    }
    .drawer.open{transform: translateX(0)}
    .drawer header{display:flex; align-items:center; justify-content:space-between; margin-bottom:10px}
    .drawer h3{margin:0}
    .drawer .form-grid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .drawer .form-grid > label{margin-top:0}
    .drawer .actions{display:flex; gap:10px; margin-top:12px}

    .modal{
      position:fixed; inset:0; display:none; place-items:center;
      background:rgba(0,0,0,.55); z-index:80;
    }
    .modal .box{
      width:min(680px, 96vw); background:var(--panel); border:1px solid var(--stroke);
      border-radius:16px; padding:16px;
    }
    .modal.show{display:grid}

    /* Toast */
    .toast{
      position:fixed; right:16px; bottom:16px;
      background:var(--panel-2);
      color:var(--text); padding:10px 14px; border-radius:12px; border:1px solid var(--stroke);
      opacity:0; transform: translateY(8px); transition:.25s ease; z-index:90;
    }
    .toast.show{opacity:1; transform:none}

  </style>
</head>
<body>
  <div class="app">
    <!-- Topbar -->
    <nav class="nav">
      <div class="brand">
        <div class="logo">MT</div>
        <div class="title">Capaciteitsplanner</div>
      </div>
      <div class="actions">
        <button class="btn secondary" onclick="openModal('about')">Over</button>
        <button class="btn" onclick="openDrawer()">Nieuwe taak</button>
      </div>
    </nav>

    <!-- Sidebar -->
    <aside class="side">
      <div class="panel">
        <h3>Filters</h3>
        <label>Vestiging
          <select id="f-workshop"></select>
        </label>
        <label>Week (maandag)
          <input type="date" id="f-week">
        </label>
        <label>Jaar (verlofmatrix)
          <select id="f-year"></select>
        </label>
        <label>Skill
          <input type="text" id="f-skill" placeholder="bv. 386, 1252, Diagnose">
        </label>
        <div class="chips" id="chips"></div>
        <button class="btn small ghost" id="btn-reset">Reset filters</button>
      </div>

      <div class="panel">
        <h3>Status</h3>
        <div class="kpis">
          <div class="kpi"><span class="v" id="kpi-cap">â€“</span><small>Beschikbare uren</small></div>
          <div class="kpi"><span class="v" id="kpi-load">â€“</span><small>Ingepland</small></div>
          <div class="kpi"><span class="v" id="kpi-util">â€“</span><small>Benutting</small></div>
          <div class="kpi"><span class="v" id="kpi-backlog">â€“</span><small>Backlog</small></div>
        </div>
      </div>

      <div class="panel">
        <h3>Acties</h3>
        <button class="btn small" id="btn-export">Export</button>
        <button class="btn small secondary" id="btn-import">Import</button>
        <input id="file" type="file" accept=".json,.csv,.xlsx" hidden />
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <!-- Hero -->
      <section class="hero">
        <div class="card">
          <h1>Capaciteitsplanner</h1>
          <p>EÃ©n rustgevende omgeving voor planning, capaciteit en verlof.</p>
          <div class="cta-row">
            <button class="btn" onclick="setTab('board')">Board</button>
            <button class="btn secondary" onclick="setTab('table')">Tabel</button>
            <button class="btn ghost" onclick="setTab('insights')">Insights</button>
          </div>
        </div>
        <div class="card">
          <div class="kpis" style="grid-template-columns:repeat(2,1fr);gap:12px">
            <div class="kpi ok"><span class="v" id="kpi-ok">98%</span><small>Datakwaliteit</small></div>
            <div class="kpi warn"><span class="v" id="kpi-sla">12</span><small>SLAâ€™s risicovol</small></div>
            <div class="kpi"><span class="v" id="kpi-open">43</span><small>Open taken</small></div>
            <div class="kpi danger"><span class="v" id="kpi-late">7</span><small>Te laat</small></div>
          </div>
          <div class="cta-row">
            <button class="btn small" onclick="toast('Auto-planning (demo) klaar')">Auto-planning</button>
            <button class="btn small secondary" onclick="toast('GeÃ«xporteerd')">Export CSV</button>
          </div>
        </div>
      </section>

      <!-- Leave matrix -->
      <section class="leave-section" aria-labelledby="leave-title">
        <div class="leave-header">
          <div>
            <h2 id="leave-title">Verlofmatrix</h2>
            <p>Direct overzicht van geplande afwezigheid en capaciteit per teamlid voor de komende weken.</p>
          </div>
          <div class="leave-legend" aria-hidden="true">
            <div class="legend-item"><span class="legend-swatch leave-swatch--vakantie"></span>Vakantie</div>
            <div class="legend-item"><span class="legend-swatch leave-swatch--verlof"></span>Verlof</div>
            <div class="legend-item"><span class="legend-swatch leave-swatch--ziek"></span>Ziek</div>
            <div class="legend-item"><span class="legend-swatch leave-swatch--training"></span>Training</div>
            <div class="legend-item"><span class="legend-swatch leave-swatch--thuis"></span>Thuiswerk</div>
            <div class="legend-item"><span class="legend-swatch leave-swatch--feestdag"></span>Feestdag</div>
            <div class="legend-item"><span class="legend-swatch leave-swatch--deeltijd"></span>Deeltijd</div>
          </div>
        </div>
        <div class="leave-matrix-wrap">
          <div id="leave-matrix" role="group" aria-describedby="leave-caption"></div>
        </div>
        <p id="leave-caption" style="margin:12px 0 0; font-size:12px; color:var(--muted);">Lege cellen betekenen volledig beschikbaar. Vul hier het aantal afwezige uren in; kleuren tonen de reden.</p>
      </section>

      <!-- Tabs -->
      <div class="tabs" role="tablist" aria-label="Planning weergaven">
        <button type="button" id="tab-board" class="tab active" role="tab" aria-selected="true" aria-controls="view-board" data-tab="board" onclick="setTab('board')">Board</button>
        <button type="button" id="tab-table" class="tab" role="tab" aria-selected="false" aria-controls="view-table" data-tab="table" onclick="setTab('table')">Tabel</button>
        <button type="button" id="tab-insights" class="tab" role="tab" aria-selected="false" aria-controls="view-insights" data-tab="insights" onclick="setTab('insights')">Insights</button>
      </div>

      <!-- Board -->
      <section id="view-board" role="tabpanel" aria-labelledby="tab-board">
        <div class="grid" id="board-grid">
          <!-- Cards komen hier -->
        </div>
      </section>

      <!-- Table -->
      <section id="view-table" role="tabpanel" aria-labelledby="tab-table" hidden>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Order</th><th>Taak</th><th>Vestiging</th><th>Skill</th><th>Uren</th><th>Deadline</th><th>Prioriteit</th><th>Status</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </section>

      <!-- Insights -->
      <section id="view-insights" role="tabpanel" aria-labelledby="tab-insights" hidden>
        <div class="grid">
          <div class="card">
            <div class="top">
              <span class="badge">Weekbalans</span>
              <span class="badge hours">320h cap</span>
            </div>
            <h4>Capaciteit vs. Werkdruk</h4>
            <p class="sub">Snelle indicatie per vestiging/week. Kleur op basis van overschrijding.</p>
            <div class="capacity-chart" id="capacity-chart">
              <div class="capacity-chart__empty">Grafiek wordt geladenâ€¦</div>
            </div>
            <div class="capacity-chart__legend" aria-hidden="true">
              <span class="legend-dot legend-dot--capacity"></span> Capaciteit
              <span class="legend-dot legend-dot--workload"></span> Werkaanbod
            </div>
            <div class="row"><span class="badge prio">Hoog risico</span><button class="btn small" onclick="toast('Insight bijgewerkt')">V verversen</button></div>
          </div>
          <div class="card">
            <div class="top"><span class="badge">SLAâ€™s</span></div>
            <h4>Naderende deadlines</h4>
            <p class="sub">Taken binnen 72 uur met norm &gt; 8 uur.</p>
            <div class="row"><span class="badge skill">Diagnose</span><button class="btn small secondary">Open lijst</button></div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Drawer (Nieuwe taak) -->
  <aside class="drawer" id="drawer">
    <header>
      <h3>Nieuwe taak</h3>
      <button class="btn small secondary" onclick="closeDrawer()">Sluiten</button>
    </header>
    <div class="form-grid">
      <label>Titel<input id="t-title" placeholder="bv. Groene Stroom 386-setup"></label>
      <label>Vestiging
        <select id="t-ws"></select>
      </label>
      <label>Skill<input id="t-skill" placeholder="bv. 386, 1252, Diagnose"></label>
      <label>Uren<input id="t-hours" type="number" min="1" step="1" value="8"></label>
      <label>Deadline<input id="t-due" type="date"></label>
      <label>Prioriteit
        <select id="t-prio">
          <option>Normaal</option>
          <option>Hoog</option>
          <option>Laag</option>
        </select>
      </label>
      <label style="grid-column:1/-1">Status
        <select id="t-status">
          <option>Open</option>
          <option>In uitvoering</option>
          <option>Gereed</option>
          <option>Geblokkeerd</option>
        </select>
      </label>
    </div>
    <div class="actions">
      <button class="btn" onclick="saveTask()">Opslaan</button>
      <button class="btn secondary" onclick="clearTask()">Leegmaken</button>
    </div>
  </aside>

  <!-- Modal Over -->
  <div class="modal" id="modal-about" onclick="if(event.target===this) closeModal('about')">
    <div class="box">
      <h3 style="margin-top:0">Over deze template</h3>
      <p>High-design HTML in de stijl van je MotracTransport-site. Donker thema, rood-accenten, glasachtige panelen, micro-interacties.</p>
      <div style="display:flex; gap:10px; margin-top:8px">
        <button class="btn small" onclick="closeModal('about')">OK</button>
        <button class="btn small secondary" onclick="toast('Documentatie geopend')">Documentatie</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">Gereed</div>

  <script>
    // ----------------------------
    // DATA DEMO (vervang dit door fetch/Supabase)
    // ----------------------------
    const state = {
      workshops: [
        {id:1, name:"Almere"},
        {id:2, name:"Venlo"},
        {id:3, name:"Zwijndrecht"},
      ],
      tasks: [
        {id:"O-10001", title:"Groene Stroom: 386-setup", workshop_id:1, skill:"386", hours:12, due_date:"2025-10-10", priority:"Hoog", status:"Open"},
        {id:"O-10002", title:"QC Reachtruck 1252", workshop_id:1, skill:"1252", hours:8,  due_date:"2025-10-14", priority:"Normaal", status:"Open"},
        {id:"O-10003", title:"Batterij wissel",        workshop_id:2, skill:"Elektrisch", hours:6, due_date:"2025-10-11", priority:"Hoog", status:"Open"},
        {id:"O-10004", title:"Demovloot klaarzetten",  workshop_id:3, skill:"Diagnose",   hours:10, due_date:"2025-10-09", priority:"Laag", status:"In uitvoering"},
      ],
      filters:{ workshop_id:"", week:"", skill:"" },
      tab:"board",
      tasksVersion:0,
      capacityByWorkshop: {
        1: 120,
        2: 110,
        3: 90,
      },
      defaultCapacity: 320,
      leaveMatrix: {
        years: [2024, 2025],
        employees: [
          {
            name:"Emma Vos",
            role:"Planner Noord",
            team:"Service Noord",
            workdayHours:8,
            entries:{
              "2024-02-16":{code:"T", type:"training", hours:4},
              "2024-08-05":{code:"V", type:"vakantie"},
              "2024-08-06":{code:"V", type:"vakantie"},
              "2024-08-07":{code:"V", type:"vakantie"},
              "2024-12-27":{code:"TW", type:"thuis"},
              "2025-01-02":{code:"Z", type:"ziek"},
              "2025-07-01":{code:"V", type:"vakantie"},
              "2025-07-02":{code:"V", type:"vakantie"},
              "2025-07-03":{code:"V", type:"vakantie"},
              "2025-07-04":{code:"V", type:"vakantie"},
              "2025-07-05":{code:"FD", type:"feestdag"},
              "2025-07-06":{code:"FD", type:"feestdag"},
              "2025-07-15":{code:"V", type:"vakantie"},
              "2025-07-16":{code:"V", type:"vakantie"},
              "2025-07-17":{code:"V", type:"vakantie"},
              "2025-07-18":{code:"V", type:"vakantie"},
              "2025-07-19":{code:"FD", type:"feestdag"},
              "2025-07-20":{code:"FD", type:"feestdag"},
              "2025-07-22":{code:"TW", type:"thuis"},
              "2025-07-23":{code:"TW", type:"thuis"},
              "2025-12-24":{code:"V", type:"vakantie"},
              "2025-12-31":{code:"V", type:"vakantie"},
            }
          },
          {
            name:"Saskia Janssen",
            role:"Planner Zuid",
            team:"Service Zuid",
            workdayHours:8,
            entries:{
              "2024-04-29":{code:"V", type:"vakantie"},
              "2024-04-30":{code:"V", type:"vakantie"},
              "2024-05-01":{code:"V", type:"vakantie"},
              "2024-10-10":{code:"L", type:"verlof"},
              "2025-03-17":{code:"T", type:"training", label:"Planner summit"},
              "2025-03-18":{code:"T", type:"training"},
              "2025-07-08":{code:"V", type:"vakantie"},
              "2025-07-09":{code:"V", type:"vakantie"},
              "2025-07-10":{code:"V", type:"vakantie"},
              "2025-07-11":{code:"V", type:"vakantie"},
              "2025-12-27":{code:"FD", type:"feestdag"},
            }
          },
          {
            name:"Daan Vermeer",
            role:"Field Service",
            team:"Service Oost",
            workdayHours:8,
            entries:{
              "2024-02-05":{code:"T", type:"training"},
              "2024-02-06":{code:"T", type:"training"},
              "2024-09-23":{code:"TW", type:"thuis"},
              "2024-09-24":{code:"TW", type:"thuis"},
              "2025-04-02":{code:"FD", type:"feestdag", label:"Regiovrije dag"},
              "2025-04-03":{code:"FD", type:"feestdag"},
              "2025-07-03":{code:"T", type:"training", label:"NEN3140 hercertificering"},
              "2025-07-04":{code:"T", type:"training"},
              "2025-07-09":{code:"TW", type:"thuis", label:"Thuiswerk"},
              "2025-07-10":{code:"TW", type:"thuis"},
              "2025-12-27":{code:"V", type:"vakantie"},
            }
          },
          {
            name:"Noor Willems",
            role:"Planner Zuid",
            team:"Service Zuid",
            workdayHours:8,
            entries:{
              "2024-06-17":{code:"DZ", type:"deeltijd", hours:4},
              "2024-09-06":{code:"L", type:"verlof"},
              "2025-02-10":{code:"TW", type:"thuis"},
              "2025-05-27":{code:"V", type:"vakantie"},
              "2025-05-28":{code:"V", type:"vakantie"},
              "2025-07-15":{code:"V", type:"vakantie"},
              "2025-07-16":{code:"V", type:"vakantie"},
              "2025-07-17":{code:"V", type:"vakantie"},
              "2025-07-18":{code:"V", type:"vakantie"},
              "2025-07-24":{code:"L", type:"verlof", label:"Lang weekend"},
              "2025-07-25":{code:"L", type:"verlof"},
            }
          },
          {
            name:"Bram de Ruiter",
            role:"Technisch Specialist",
            team:"Diagnose",
            workdayHours:6,
            entries:{
              "2024-01-08":{code:"DZ", type:"deeltijd", hours:3},
              "2024-01-15":{code:"DZ", type:"deeltijd"},
              "2024-05-14":{code:"TW", type:"thuis"},
              "2024-12-03":{code:"DZ", type:"deeltijd"},
              "2025-03-04":{code:"TW", type:"thuis"},
              "2025-06-03":{code:"DZ", type:"deeltijd"},
              "2025-07-07":{code:"DZ", type:"deeltijd", label:"Deeltijd (ouders)", hours:3},
              "2025-07-14":{code:"DZ", type:"deeltijd"},
              "2025-07-21":{code:"DZ", type:"deeltijd"},
              "2025-07-28":{code:"DZ", type:"deeltijd"},
              "2025-07-29":{code:"TW", type:"thuis"},
              "2025-07-30":{code:"TW", type:"thuis"},
            }
          },
          {
            name:"Esmee van Leeuwen",
            role:"Customer Care",
            team:"Operations",
            workdayHours:7.5,
            entries:{
              "2024-11-04":{code:"Z", type:"ziek"},
              "2024-11-05":{code:"Z", type:"ziek"},
              "2025-03-21":{code:"TW", type:"thuis"},
              "2025-07-11":{code:"Z", type:"ziek"},
              "2025-07-12":{code:"Z", type:"ziek"},
              "2025-07-13":{code:"Z", type:"ziek"},
              "2025-07-18":{code:"TW", type:"thuis"},
              "2025-07-31":{code:"L", type:"verlof", label:"Vrije middag", hours:3.5},
            }
          },
          {
            name:"Jamal Essers",
            role:"Service CoÃ¶rdinator",
            team:"Service Noord",
            workdayHours:8,
            entries:{
              "2024-12-26":{code:"FD", type:"feestdag"},
              "2025-05-09":{code:"TW", type:"thuis"},
              "2025-07-05":{code:"FD", type:"feestdag"},
              "2025-07-06":{code:"FD", type:"feestdag"},
              "2025-07-19":{code:"FD", type:"feestdag"},
              "2025-07-20":{code:"FD", type:"feestdag"},
              "2025-07-22":{code:"TW", type:"thuis"},
              "2025-07-23":{code:"TW", type:"thuis"},
            }
          },
          {
            name:"Lotte Sanders",
            role:"Planner",
            team:"Warehouse",
            workdayHours:8,
            entries:{
              "2024-03-11":{code:"L", type:"verlof"},
              "2024-05-01":{code:"FD", type:"feestdag"},
              "2024-11-18":{code:"TW", type:"thuis"},
              "2025-02-14":{code:"T", type:"training", label:"Lean training"},
              "2025-05-06":{code:"V", type:"vakantie"},
              "2025-05-07":{code:"V", type:"vakantie"},
              "2025-07-01":{code:"L", type:"verlof"},
              "2025-07-02":{code:"L", type:"verlof"},
              "2025-07-18":{code:"T", type:"training", label:"Lean training"},
              "2025-07-19":{code:"T", type:"training"},
              "2025-07-30":{code:"V", type:"vakantie"},
              "2025-07-31":{code:"V", type:"vakantie"},
              "2025-10-21":{code:"Z", type:"ziek"},
            }
          },
          {
            name:"Robert Kiers",
            role:"Planner West",
            team:"Service West",
            workdayHours:8,
            entries:{
              "2024-01-15":{code:"TW", type:"thuis"},
              "2024-01-16":{code:"TW", type:"thuis"},
              "2024-07-22":{code:"V", type:"vakantie"},
              "2024-07-23":{code:"V", type:"vakantie"},
              "2025-07-08":{code:"TW", type:"thuis"},
              "2025-07-09":{code:"TW", type:"thuis"},
              "2025-07-10":{code:"TW", type:"thuis"},
              "2025-07-11":{code:"TW", type:"thuis"},
              "2025-07-24":{code:"V", type:"vakantie"},
              "2025-07-25":{code:"V", type:"vakantie"},
              "2025-07-26":{code:"V", type:"vakantie"},
              "2025-11-04":{code:"S", type:"ziek"},
            }
          }
        ]
      },
      currentLeaveYear: todayUtc().getUTCFullYear(),
      leaveMatrixScrollYear: null,
    };

    let filteredTasksCache = {signature:null, value:[]};

    const WEEKDAY_LABELS = ["zo","ma","di","wo","do","vr","za"];
    const MONTH_LABELS = ["jan","feb","mrt","apr","mei","jun","jul","aug","sep","okt","nov","dec"];
    const LEAVE_TYPES = [
      {value:"vakantie", label:"Vakantie", code:"V"},
      {value:"verlof", label:"Verlof", code:"L"},
      {value:"ziek", label:"Ziek", code:"Z"},
      {value:"training", label:"Training", code:"T"},
      {value:"thuis", label:"Thuiswerk", code:"TW"},
      {value:"feestdag", label:"Feestdag", code:"FD"},
      {value:"deeltijd", label:"Deeltijd", code:"DZ"},
    ];
    const DEFAULT_WORKDAY_HOURS = 8;
    const NUMBER_FORMATTER = new Intl.NumberFormat('nl-NL');

    // Init
    document.addEventListener("DOMContentLoaded", () => {
      fillFilters();
      renderAll();

      document.getElementById("btn-reset").addEventListener("click", () => {
        state.filters = {workshop_id:"", week:"", skill:""};
        document.getElementById("f-workshop").value = "";
        document.getElementById("f-week").value = "";
        document.getElementById("f-skill").value = "";
        renderAll();
      });

      document.getElementById("btn-export").addEventListener("click", exportCSV);
      document.getElementById("btn-import").addEventListener("click", ()=> document.getElementById("file").click());
      document.getElementById("file").addEventListener("change", handleImport);

      const leaveHost = document.getElementById("leave-matrix");
      if(leaveHost){
        leaveHost.addEventListener("change", handleLeaveMatrixChange);
        leaveHost.addEventListener("input", handleLeaveMatrixInput);
      }
    });

    function fillFilters(){
      const sel = document.getElementById("f-workshop");
      sel.innerHTML = '<option value="">Alle vestigingen</option>' + state.workshops.map(w=>`<option value="${w.id}">${w.name}</option>`).join('');
      sel.addEventListener("change", e => { state.filters.workshop_id = e.target.value; renderAll(); });

      document.getElementById("f-week").addEventListener("change", e => { state.filters.week = e.target.value; renderAll(); });
      document.getElementById("f-skill").addEventListener("input", e => {
        state.filters.skill = e.target.value;
        renderAll();
      });

      const yearSel = document.getElementById("f-year");
      if(yearSel){
        const years = Array.isArray(state.leaveMatrix?.years) ? [...state.leaveMatrix.years].sort((a,b)=>a-b) : [];
        const fallbackYear = todayUtc().getUTCFullYear();
        const options = years.length ? years : [fallbackYear];
        yearSel.innerHTML = options.map(y=>`<option value="${y}">${y}</option>`).join('');
        const currentYear = options.includes(state.currentLeaveYear) ? state.currentLeaveYear : options[options.length-1];
        state.currentLeaveYear = currentYear;
        state.leaveMatrixScrollYear = null;
        yearSel.value = String(currentYear);
        yearSel.addEventListener("change", e => {
          const value = Number(e.target.value);
          if(Number.isFinite(value)){
            state.currentLeaveYear = value;
            state.leaveMatrixScrollYear = null;
            renderLeaveMatrix();
          }
        });
      }

      // Drawer select
      const tsel = document.getElementById("t-ws");
      tsel.innerHTML = state.workshops.map(w=>`<option value="${w.id}">${w.name}</option>`).join('');
    }

    function renderAll(){
      const tasks = getFilteredTasks();
      renderChips();
      renderKPIs(tasks);
      renderHeroStats(tasks);
      renderBoard(tasks);
      renderTable(tasks);
      renderLeaveMatrix();
      setTab(state.tab);
    }

    function getFilteredTasks(){
      const filters = state.filters || {};
      const skillTerm = filters.skill ? filters.skill.trim().toLowerCase() : "";
      const workshopFilter = filters.workshop_id ? Number(filters.workshop_id) : null;
      const useWorkshopFilter = Number.isFinite(workshopFilter);
      const signature = [
        state.tasksVersion,
        state.tasks.length,
        useWorkshopFilter ? workshopFilter : "",
        filters.week || "",
        skillTerm
      ].join("|");
      if(filteredTasksCache.signature === signature){
        return filteredTasksCache.value;
      }

      const selectedWeekDate = parseISODate(filters.week);
      const selectedWeekInfo = selectedWeekDate ? isoWeek(selectedWeekDate) : null;
      const items = [];

      for(const task of state.tasks){
        if(useWorkshopFilter && Number(task.workshop_id) !== workshopFilter) continue;
        if(skillTerm){
          const skillValue = String(task.skill || "").toLowerCase();
          if(!skillValue.includes(skillTerm)) continue;
        }
        const dueDate = parseISODate(task.due_date);
        if(selectedWeekInfo){
          if(!dueDate) continue;
          const dueWeek = isoWeek(dueDate);
          if(dueWeek.year !== selectedWeekInfo.year || dueWeek.week !== selectedWeekInfo.week) continue;
        }
        const safe = safeHours(task.hours);
        items.push({
          ...task,
          dueDate,
          safeHours: safe,
        });
      }

      items.sort((a,b)=>{
        const pr = prioRank(a.priority) - prioRank(b.priority);
        if(pr !== 0) return pr;
        if(a.dueDate && b.dueDate){
          if(a.dueDate < b.dueDate) return -1;
          if(a.dueDate > b.dueDate) return 1;
        }else if(a.dueDate){
          return -1;
        }else if(b.dueDate){
          return 1;
        }
        const diff = b.safeHours - a.safeHours;
        if(diff !== 0) return diff;
        return String(a.title||"").localeCompare(String(b.title||""), "nl", {sensitivity:"base"});
      });

      filteredTasksCache = {signature, value: items};
      return filteredTasksCache.value;
    }

    function getTasksForChart(){
      const filters = state.filters || {};
      const skillTerm = filters.skill ? filters.skill.trim().toLowerCase() : "";
      const workshopFilter = filters.workshop_id ? Number(filters.workshop_id) : null;
      const useWorkshopFilter = Number.isFinite(workshopFilter);
      const items = [];
      for(const task of state.tasks){
        if(useWorkshopFilter && Number(task.workshop_id) !== workshopFilter) continue;
        if(skillTerm){
          const skillValue = String(task.skill || "").toLowerCase();
          if(!skillValue.includes(skillTerm)) continue;
        }
        items.push(task);
      }
      return items;
    }

    function invalidateFilteredTasks(){
      filteredTasksCache = {signature:null, value:[]};
    }
    function prioRank(p){ return p==="Hoog"?0:p==="Normaal"?1:2; }

    function renderChips(){
      const el = document.getElementById("chips");
      const chips = [];
      if(state.filters.workshop_id){
        const w = state.workshops.find(x=>x.id===Number(state.filters.workshop_id));
        chips.push(chip(`Vestiging: ${w?.name||"?"}`, ()=>{ state.filters.workshop_id=""; document.getElementById("f-workshop").value=""; renderAll(); }));
      }
      if(state.filters.week){
        chips.push(chip(`Week: ${formatWeekLabel(state.filters.week)}`, ()=>{ state.filters.week=""; document.getElementById("f-week").value=""; renderAll(); }));
      }
      const skillFilter = state.filters.skill ? state.filters.skill.trim() : "";
      if(skillFilter){
        chips.push(chip(`Skill: ${skillFilter}`, ()=>{
          state.filters.skill="";
          document.getElementById("f-skill").value="";
          renderAll();
        }));
      }
      el.innerHTML = ""; chips.forEach(c=>el.appendChild(c));
    }
    function chip(text,onClose){
      const btn=document.createElement("button");
      btn.type="button";
      btn.className="chip";
      btn.innerHTML=`<span class="chip-label">${escapeHtml(text)}</span><span aria-hidden="true">âœ•</span>`;
      btn.setAttribute("aria-label", `${text} verwijderen`);
      btn.addEventListener("click", onClose);
      return btn;
    }

    function renderKPIs(tasks){
      const capacity = currentCapacity();
      const totalHours = tasks.reduce((sum,t)=> {
        const value = Number.isFinite(t.safeHours) ? t.safeHours : safeHours(t.hours);
        return sum + value;
      }, 0);
      const plannedHours = tasks.reduce((sum,t)=> {
        if(isDone(t.status)) return sum;
        const value = Number.isFinite(t.safeHours) ? t.safeHours : safeHours(t.hours);
        return sum + value;
      }, 0);
      const utilisation = capacity>0 ? Math.min(100, Math.round((plannedHours/capacity)*100)) : 0;
      const backlog = capacity>0 ? Math.max(0, totalHours - capacity) : totalHours;

      setText("kpi-cap", capacity);
      setText("kpi-load", plannedHours);
      setText("kpi-util", utilisation + "%");
      setText("kpi-backlog", backlog);
    }

    function renderHeroStats(tasks){
      const today = todayUtc();
      const info = tasks.reduce((acc,t)=>{
        const due = t.dueDate || parseISODate(t.due_date);
        const done = isDone(t.status);
        const hasCoreData = Boolean(t.title && due && t.skill);
        if(hasCoreData) acc.completeData += 1;
        if(!done) acc.open += 1;
        if(!done && due){
          const delta = Math.ceil((due - today)/DAY_MS);
          if(delta < 0) acc.overdue += 1;
          if(delta >= 0 && delta <= 7) acc.atRisk += 1;
        }
        return acc;
      }, {open:0, overdue:0, atRisk:0, completeData:0});
      const quality = tasks.length ? Math.round(Math.min(1, info.completeData / tasks.length)*100) : 100;

      setText("kpi-ok", quality + "%");
      setText("kpi-sla", info.atRisk);
      setText("kpi-open", info.open);
      setText("kpi-late", info.overdue);
    }

    function renderBoard(tasks){
      const container = document.getElementById("board-grid");
      container.innerHTML = "";
      tasks.forEach(t=>{
        const hoursLabel = formatHoursValue(Number.isFinite(t.safeHours) ? t.safeHours : safeHours(t.hours));
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="top">
            <span class="badge prio">${t.priority}</span>
            <span class="badge skill">${t.skill||"â€”"}</span>
            <span class="badge hours">${hoursLabel || "0"}h</span>
          </div>
          <h4>${escapeHtml(t.title)}</h4>
          <div class="sub">Due ${t.due_date||"â€”"} â€¢ ${workshopName(t.workshop_id)}</div>
          <div class="row">
            <span class="badge">${t.status||"Open"}</span>
            <div>
              <button class="btn small secondary" onclick="editTask('${t.id}')">Bewerk</button>
              <button class="btn small" onclick="toast('Gepland op beste lane (demo)')">Plan</button>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function renderTable(tasks){
      const tb = document.getElementById("tbody");
      tb.innerHTML = tasks.map(t=>{
        const hoursLabel = formatHoursValue(Number.isFinite(t.safeHours) ? t.safeHours : safeHours(t.hours));
        const cells = [
          {label:"Order", value: escapeHtml(String(t.id))},
          {label:"Taak", value: escapeHtml(t.title||"â€”")},
          {label:"Vestiging", value: escapeHtml(workshopName(t.workshop_id))},
          {label:"Skill", value: escapeHtml(t.skill||"â€”")},
          {label:"Uren", value: escapeHtml(hoursLabel || "0")},
          {label:"Deadline", value: escapeHtml(t.due_date||"â€”")},
          {label:"Prioriteit", value: escapeHtml(t.priority||"â€”")},
          {label:"Status", value: escapeHtml(t.status||"â€”")}
        ];
        return `
          <tr>
            ${cells.map(cell => `<td data-label="${cell.label}">${cell.value}</td>`).join("")}
          </tr>
        `;
      }).join('');
    }

    function renderCapacityChart(yearOverride){
      const host = document.getElementById("capacity-chart");
      if(!host) return;
      const year = Number.isFinite(Number(yearOverride)) ? Number(yearOverride) : Number(state.currentLeaveYear) || todayUtc().getUTCFullYear();
      if(!Number.isFinite(year)){
        host.innerHTML = `<div class="capacity-chart__empty">Geen data beschikbaar.</div>`;
        host.removeAttribute("role");
        host.removeAttribute("aria-label");
        return;
      }

      const series = buildWeeklyCapacitySeries(year);
      if(!series.length){
        host.innerHTML = `<div class="capacity-chart__empty">Geen data voor ${year}.</div>`;
        host.setAttribute("role", "img");
        host.setAttribute("aria-label", `Geen capaciteit of werkaanbod geregistreerd in ${year}.`);
        return;
      }

      const maxValue = Math.max(...series.map(item => Math.max(item.capacity, item.workload)));
      if(!(maxValue > 0)){
        host.innerHTML = `<div class="capacity-chart__empty">Geen geregistreerde uren voor ${year}.</div>`;
        host.setAttribute("role", "img");
        host.setAttribute("aria-label", `Geen geregistreerde uren voor ${year}.`);
        return;
      }

      host.innerHTML = buildCapacitySvg(series, maxValue);
      host.setAttribute("role", "img");
      host.setAttribute("aria-label", `Capaciteit en werkaanbod per week voor ${year}.`);
    }

    function renderLeaveMatrix(){
      const host = document.getElementById("leave-matrix");
      const matrix = state.leaveMatrix || {};
      const availableYears = Array.isArray(matrix.years) && matrix.years.length ? [...matrix.years].sort((a,b)=>a-b) : [];
      let year = Number(state.currentLeaveYear);
      const fallback = availableYears.length ? availableYears[availableYears.length-1] : todayUtc().getUTCFullYear();
      if(!Number.isFinite(year) || (availableYears.length && !availableYears.includes(year))){
        year = fallback;
        if(state.currentLeaveYear !== year){
          state.currentLeaveYear = year;
          state.leaveMatrixScrollYear = null;
        }
      }

      const yearSelect = document.getElementById("f-year");
      if(yearSelect && yearSelect.value !== String(year)){
        yearSelect.value = String(year);
      }

      renderCapacityChart(year);

      if(!host) return;

      const days = buildLeaveDays(year);
      const employees = Array.isArray(matrix.employees) ? matrix.employees : [];
      host.innerHTML = "";

      if(!days.length || !employees.length){
        host.textContent = "Geen verlofdata beschikbaar.";
        return;
      }

      const table = document.createElement("table");
      table.className = "leave-matrix";
      const caption = document.createElement("caption");
      caption.textContent = `Volledig jaar ${year} (1 januari â€“ 31 december)`;
      table.appendChild(caption);

      const thead = document.createElement("thead");
      const monthRow = document.createElement("tr");
      const nameTh = document.createElement("th");
      nameTh.scope = "col";
      nameTh.rowSpan = 3;
      nameTh.textContent = "Naam";
      monthRow.appendChild(nameTh);

      const teamTh = document.createElement("th");
      teamTh.scope = "col";
      teamTh.rowSpan = 3;
      teamTh.textContent = "Team";
      monthRow.appendChild(teamTh);

      const monthGroups = [];
      let currentMonth = null;
      days.forEach(day => {
        if(!currentMonth || currentMonth.month !== day.month){
          currentMonth = {month: day.month, label: day.monthLabel, span:1};
          monthGroups.push(currentMonth);
        }else{
          currentMonth.span += 1;
        }
      });
      monthGroups.forEach(group => {
        const th = document.createElement("th");
        th.colSpan = group.span;
        th.textContent = group.label.charAt(0).toUpperCase() + group.label.slice(1);
        th.className = "month-group";
        monthRow.appendChild(th);
      });
      thead.appendChild(monthRow);

      const weekRow = document.createElement("tr");
      const weekGroups = [];
      let currentWeek = null;
      days.forEach(day => {
        if(!currentWeek || currentWeek.week !== day.week || currentWeek.year !== day.isoYear){
          currentWeek = {week: day.week, year: day.isoYear, span:1};
          weekGroups.push(currentWeek);
        }else{
          currentWeek.span += 1;
        }
      });
      weekGroups.forEach(group => {
        const th = document.createElement("th");
        th.colSpan = group.span;
        let label = `Week ${String(group.week).padStart(2,'0')}`;
        if(group.year !== year){
          label += ` (${group.year})`;
        }
        th.textContent = label;
        weekRow.appendChild(th);
      });
      thead.appendChild(weekRow);

      const dayRow = document.createElement("tr");
      days.forEach(day => {
        const th = document.createElement("th");
        th.scope = "col";
        th.textContent = `${day.weekday} ${day.label}`;
        th.dataset.date = day.date;
        if(day.weekend) th.classList.add("is-weekend");
        const monthTitle = day.monthLabel ? day.monthLabel.charAt(0).toUpperCase() + day.monthLabel.slice(1) : "";
        th.title = `${day.label} ${monthTitle} ${year}`.trim();
        dayRow.appendChild(th);
      });
      thead.appendChild(dayRow);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      employees.forEach((emp, empIndex) => {
        const tr = document.createElement("tr");
        const rowTh = document.createElement("th");
        rowTh.scope = "row";
        rowTh.innerHTML = `${escapeHtml(emp.name)}<span class="meta">${escapeHtml(emp.role||"")}</span>`;
        tr.appendChild(rowTh);

        const teamCell = document.createElement("td");
        teamCell.className = "team";
        teamCell.textContent = emp.team || "â€“";
        tr.appendChild(teamCell);

        const entries = emp.entries || {};
        days.forEach(day => {
          const td = document.createElement("td");
          td.dataset.date = day.date;
          const entry = entries[day.date];
          const stack = document.createElement("div");
          stack.className = "cell-stack";

          const input = document.createElement("input");
          input.type = "number";
          input.inputMode = "decimal";
          input.className = "leave-input";
          input.placeholder = "0";
          input.min = "0";
          const maxHours = workdayHours(emp);
          input.max = String(maxHours);
          input.step = "0.25";
          input.dataset.emp = String(empIndex);
          input.dataset.date = day.date;
          const readableDate = `${day.label} ${day.monthLabel ? day.monthLabel : ""} ${year}`.trim();
          input.setAttribute("aria-label", `${emp.name} â€“ ${readableDate}`);

          let hasAbsence = false;
          let typeClass = "";
          if(entry){
            normaliseLeaveEntry(entry, emp);
            const hoursValue = Number(entry.hours);
            if(entry.label){
              td.title = entry.label;
            }
            if(Number.isFinite(hoursValue) && hoursValue > 0){
              hasAbsence = true;
              const formatted = formatHoursValue(hoursValue);
              input.value = formatted;
              const reasonLabel = leaveTypeLabel(entry.type);
              input.title = `${formatted} uur afwezig (${reasonLabel})`;
              typeClass = String(entry.type||'verlof').toLowerCase().replace(/[^a-z0-9]+/g,'-');
            }else{
              input.value = "";
            }
          }else{
            input.value = "";
          }
          if(!input.value){
            input.removeAttribute("title");
            td.removeAttribute("title");
          }
          stack.appendChild(input);

          const reasonSelect = document.createElement("select");
          reasonSelect.className = "leave-reason";
          reasonSelect.dataset.emp = String(empIndex);
          reasonSelect.dataset.date = day.date;
          reasonSelect.setAttribute("aria-label", `Reden afwezigheid ${emp.name} â€“ ${readableDate}`);
          const reasonOptions = buildLeaveReasonOptions(entry);
          reasonSelect.innerHTML = reasonOptions.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('');
          const selectedType = entry && entry.type && reasonOptions.some(opt => opt.value===entry.type)
            ? entry.type
            : reasonOptions[0] ? reasonOptions[0].value : "";
          if(selectedType){
            reasonSelect.value = selectedType;
          }
          if(hasAbsence){
            reasonSelect.disabled = false;
          }else{
            reasonSelect.disabled = true;
            reasonSelect.classList.add("is-hidden");
          }
          stack.appendChild(reasonSelect);

          if(hasAbsence){
            td.classList.add("has-absence");
            if(typeClass){
              td.classList.add(`absence--${typeClass}`);
            }
          }else{
            td.classList.add("empty");
          }
          if(day.weekend) td.classList.add("is-weekend");
          td.appendChild(stack);
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      host.appendChild(table);

      if(state.leaveMatrixScrollYear !== year){
        const wrap = host.closest(".leave-matrix-wrap");
        const scrollToWeeks = () => {
          if(wrap) scrollLeaveMatrixToCurrentWeeks(wrap, table);
        };
        if(typeof requestAnimationFrame === "function"){
          requestAnimationFrame(scrollToWeeks);
        }else{
          setTimeout(scrollToWeeks, 0);
        }
        state.leaveMatrixScrollYear = year;
      }
    }

    function setTab(tab){
      state.tab = tab;
      document.querySelectorAll(".tab").forEach(el => {
        const isActive = el.dataset.tab===tab;
        el.classList.toggle("active", isActive);
        el.setAttribute("aria-selected", isActive ? "true" : "false");
      });
      document.getElementById("view-board").hidden = tab!=="board";
      document.getElementById("view-table").hidden = tab!=="table";
      document.getElementById("view-insights").hidden = tab!=="insights";
    }

    function workshopName(id){ return (state.workshops.find(w=>w.id===id)||{}).name||"?"; }
    function setText(id,val){ const el=document.getElementById(id); if(el) el.textContent = val; }
    function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[c])); }
    function workdayHours(emp){
      const hours = Number(emp && emp.workdayHours);
      return Number.isFinite(hours) && hours > 0 ? hours : DEFAULT_WORKDAY_HOURS;
    }
    function clampHours(emp, value){
      const max = workdayHours(emp);
      const num = Number(value);
      if(!Number.isFinite(num)) return max;
      const bounded = Math.min(Math.max(num, 0), max);
      return Math.round(bounded * 4) / 4;
    }
    function formatHoursValue(value){
      const num = Number(value);
      if(!Number.isFinite(num)) return "";
      return Number.isInteger(num) ? String(num) : String(Number(num.toFixed(2)));
    }
    function leaveTypeLabel(type){
      const cfg = LEAVE_TYPES.find(opt => opt.value === type);
      if(cfg) return cfg.label;
      return capitalize(String(type||""));
    }
    function leaveCodeForType(type){
      const cfg = LEAVE_TYPES.find(opt => opt.value === type);
      if(cfg && cfg.code) return cfg.code;
      const cleaned = String(type||"").replace(/[^a-z0-9]/gi,"");
      if(!cleaned) return "";
      return cleaned.slice(0,2).toUpperCase();
    }
    function buildLeaveReasonOptions(entry){
      const options = LEAVE_TYPES.slice();
      if(entry && entry.type && !options.some(opt => opt.value===entry.type)){
        options.push({value: entry.type, label: leaveTypeLabel(entry.type), code: entry.code || leaveCodeForType(entry.type)});
      }
      return options;
    }
    function normaliseLeaveEntry(entry, emp){
      if(!entry) return null;
      if(!entry.type) entry.type = LEAVE_TYPES[0].value;
      if(!entry.code) entry.code = leaveCodeForType(entry.type);
      entry.hours = clampHours(emp, entry.hours);
      return entry;
    }
    function capitalize(str){
      if(!str) return "";
      return str.charAt(0).toUpperCase() + str.slice(1);
    }
    function parseISODate(str){
      if(!str) return null;
      const m = String(str).match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if(!m) return null;
      const [_,y,mth,d] = m;
      const date = new Date(Date.UTC(Number(y), Number(mth)-1, Number(d)));
      if(Number.isNaN(date.getTime())) return null;
      if(date.getUTCFullYear()!==Number(y) || date.getUTCMonth()!==Number(mth)-1 || date.getUTCDate()!==Number(d)) return null;
      return date;
    }
    const DAY_MS = 24*60*60*1000;
    function startOfISOWeek(date){
      const result = new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate()));
      const day = result.getUTCDay();
      const diff = day === 0 ? -6 : 1 - day;
      result.setUTCDate(result.getUTCDate() + diff);
      return result;
    }
    function isoWeek(date){
      const target = new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate()));
      const dayNr = target.getUTCDay() || 7;
      target.setUTCDate(target.getUTCDate() + 4 - dayNr);
      const yearStart = new Date(Date.UTC(target.getUTCFullYear(),0,1));
      const week = Math.ceil((((target - yearStart)/DAY_MS) + 1)/7);
      return {week, year: target.getUTCFullYear()};
    }
    function todayUtc(){
      const now = new Date();
      return new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
    }
    function safeHours(val){ const num = Number(val); return Number.isFinite(num) && num>0 ? num : 0; }
    function isDone(status){ return String(status||"").toLowerCase()==="gereed"; }
    function currentCapacity(){
      const map = state.capacityByWorkshop||{};
      const fallback = Number.isFinite(state.defaultCapacity) ? Number(state.defaultCapacity) : 0;
      if(state.filters.workshop_id){
        const id = Number(state.filters.workshop_id);
        if(Number.isFinite(map[id])) return Number(map[id]);
        const total = totalCapacity(map);
        return total>0 ? total : fallback;
      }
      const total = totalCapacity(map);
      return total>0 ? total : fallback;
    }
    function totalCapacity(map){
      const values = Object.values(map).map(v=>Number(v)).filter(v=>Number.isFinite(v) && v>0);
      if(!values.length) return 0;
      return values.reduce((sum,v)=> sum + v, 0);
    }
    function formatWeekLabel(value){
      const date = parseISODate(value);
      if(!date) return value;
      const info = isoWeek(date);
      return `Week ${String(info.week).padStart(2,'0')} (${value})`;
    }

    function buildLeaveDays(year){
      if(!Number.isFinite(year)) return [];
      const start = new Date(Date.UTC(year,0,1));
      const end = new Date(Date.UTC(year+1,0,1));
      const days = [];
      const cursor = new Date(start);
      while(cursor < end){
        const current = new Date(cursor);
        const iso = isoWeek(current);
        const weekdayIndex = current.getUTCDay();
        const monthIndex = current.getUTCMonth();
        days.push({
          date: formatISODate(current),
          label: String(current.getUTCDate()).padStart(2,'0'),
          weekday: WEEKDAY_LABELS[weekdayIndex] || "",
          week: iso.week,
          isoYear: iso.year,
          weekend: weekdayIndex === 0 || weekdayIndex === 6,
          month: monthIndex,
          monthLabel: MONTH_LABELS[monthIndex] || "",
        });
        cursor.setUTCDate(cursor.getUTCDate() + 1);
      }
      return days;
    }

    function formatISODate(date){
      const y = date.getUTCFullYear();
      const m = String(date.getUTCMonth()+1).padStart(2,'0');
      const d = String(date.getUTCDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }

    function buildWeeklyCapacitySeries(year){
      if(!Number.isFinite(year)) return [];
      const weekly = new Map();
      const leaveState = state.leaveMatrix || {};
      const employees = Array.isArray(leaveState.employees) ? leaveState.employees : [];
      const totalDailyCapacity = employees.reduce((sum, emp) => sum + workdayHours(emp), 0);
      const ensureEntry = (isoYear, week) => {
        const key = `${isoYear}-W${String(week).padStart(2,'0')}`;
        let entry = weekly.get(key);
        if(!entry){
          entry = {week, year: isoYear, capacity:0, workload:0};
          weekly.set(key, entry);
        }
        return entry;
      };

      const days = buildLeaveDays(year);
      days.forEach(day => {
        const entry = ensureEntry(day.isoYear, day.week);
        if(!day.weekend && totalDailyCapacity > 0){
          entry.capacity += totalDailyCapacity;
        }
        if(employees.length){
          employees.forEach(emp => {
            const entries = emp && emp.entries ? emp.entries : null;
            if(!entries) return;
            const original = entries[day.date];
            if(!original) return;
            const clone = {...original};
            normaliseLeaveEntry(clone, emp);
            const hours = Number(clone.hours);
            if(Number.isFinite(hours) && hours > 0){
              entry.capacity -= hours;
            }
          });
        }
      });

      const tasks = getTasksForChart();
      tasks.forEach(task => {
        const dueDate = parseISODate(task.due_date);
        if(!dueDate) return;
        if(dueDate.getUTCFullYear() !== year) return;
        const info = isoWeek(dueDate);
        const entry = ensureEntry(info.year, info.week);
        const rawHours = Number.isFinite(task.safeHours) ? Number(task.safeHours) : safeHours(task.hours);
        if(rawHours > 0){
          entry.workload += rawHours;
        }
      });

      const multiplier = chartCapacityMultiplier(totalDailyCapacity);
      const series = Array.from(weekly.values()).map(item => {
        const scaledCapacity = Math.max(0, Math.round(Math.max(0, item.capacity) * multiplier * 4) / 4);
        const workloadValue = Math.max(0, Math.round(Math.max(0, item.workload) * 4) / 4);
        const baseLabel = `W${String(item.week).padStart(2,'0')}`;
        const label = item.year === year ? baseLabel : `${baseLabel} (${String(item.year).slice(-2)})`;
        return {
          week: item.week,
          year: item.year,
          capacity: scaledCapacity,
          workload: workloadValue,
          label,
        };
      }).sort((a,b) => {
        if(a.year === b.year) return a.week - b.week;
        return a.year - b.year;
      });

      return series;
    }

    function chartCapacityMultiplier(totalDailyCapacity){
      const map = state.capacityByWorkshop || {};
      const configuredTotal = totalCapacity(map) || (Number.isFinite(state.defaultCapacity) ? Number(state.defaultCapacity) : 0);
      const baselineWeekly = totalDailyCapacity * 5;
      let baseScale = 1;
      if(baselineWeekly > 0 && configuredTotal > 0){
        baseScale = configuredTotal / baselineWeekly;
      }
      let share = 1;
      const workshopFilter = state.filters && state.filters.workshop_id ? Number(state.filters.workshop_id) : NaN;
      if(Number.isFinite(workshopFilter) && configuredTotal > 0){
        const value = Number(map[workshopFilter]);
        if(Number.isFinite(value) && value > 0){
          share = value / configuredTotal;
        }
      }
      return baseScale * share;
    }

    function buildCapacitySvg(series, maxValue){
      const viewWidth = 860;
      const viewHeight = 280;
      const padding = {top:18, right:24, bottom:36, left:56};
      const innerWidth = Math.max(0, viewWidth - padding.left - padding.right);
      const innerHeight = Math.max(0, viewHeight - padding.top - padding.bottom);
      const step = series.length > 1 ? innerWidth / (series.length - 1) : 0;
      const baseY = padding.top + innerHeight;
      const pointX = index => {
        if(series.length <= 1){
          return padding.left + innerWidth / 2;
        }
        return padding.left + step * index;
      };
      const pointY = value => {
        if(!(maxValue > 0)) return baseY;
        const ratio = Math.min(Math.max(value / maxValue, 0), 1);
        return padding.top + (1 - ratio) * innerHeight;
      };

      let workloadArea = "";
      let workloadLine = "";
      series.forEach((entry, index) => {
        const x = pointX(index);
        const y = pointY(entry.workload);
        if(index === 0){
          workloadArea = `M ${x} ${y}`;
          workloadLine = `M ${x} ${y}`;
        }else{
          workloadArea += ` L ${x} ${y}`;
          workloadLine += ` L ${x} ${y}`;
        }
      });
      if(workloadArea){
        const lastX = pointX(series.length - 1);
        const firstX = pointX(0);
        workloadArea += ` L ${lastX} ${baseY} L ${firstX} ${baseY} Z`;
      }

      let capacityLine = "";
      series.forEach((entry, index) => {
        const x = pointX(index);
        const y = pointY(entry.capacity);
        capacityLine += index === 0 ? `M ${x} ${y}` : ` L ${x} ${y}`;
      });

      const ticks = buildYTicks(maxValue);
      const gridLines = ticks.map(tick => {
        const y = pointY(tick);
        return `<line x1="${padding.left}" y1="${y}" x2="${padding.left + innerWidth}" y2="${y}" class="capacity-chart__grid" />`;
      }).join("\n");
      const yLabels = ticks.map(tick => {
        const y = pointY(tick);
        return `<text x="${padding.left - 10}" y="${y + 4}" class="capacity-chart__tick" text-anchor="end">${formatChartNumber(tick)}</text>`;
      }).join("\n");

      const labelEvery = Math.max(1, Math.round(series.length / 8));
      const xLabels = series.map((entry, index) => {
        if(index !== 0 && index !== series.length - 1 && index % labelEvery !== 0) return "";
        const x = pointX(index);
        return `<text x="${x}" y="${baseY + 18}" class="capacity-chart__tick" text-anchor="middle">${entry.label}</text>`;
      }).filter(Boolean).join("\n");

      const markers = series.map((entry, index) => {
        const x = pointX(index);
        const workloadY = pointY(entry.workload);
        const capacityY = pointY(entry.capacity);
        return `<circle cx="${x}" cy="${workloadY}" r="2.8" class="capacity-chart__dot workload" />\n      <circle cx="${x}" cy="${capacityY}" r="2.8" class="capacity-chart__dot capacity" />`;
      }).join("\n      ");

      return `<svg viewBox="0 0 ${viewWidth} ${viewHeight}" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
  <defs>
    <linearGradient id="chart-workload-fill" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="var(--ok)" stop-opacity="0.35" />
      <stop offset="100%" stop-color="var(--ok)" stop-opacity="0" />
    </linearGradient>
  </defs>
  <g>
${gridLines}
  </g>
  <path d="${workloadArea}" fill="url(#chart-workload-fill)" />
  <path d="${workloadLine}" fill="none" stroke="var(--ok)" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" />
  <path d="${capacityLine}" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" />
  <g>
${markers}
  </g>
  <line x1="${padding.left}" y1="${baseY}" x2="${padding.left + innerWidth}" y2="${baseY}" stroke="var(--stroke)" stroke-width="1" />
  <g>
${yLabels}
${xLabels}
  </g>
</svg>`;
    }

    function buildYTicks(maxValue){
      if(!(maxValue > 0)) return [];
      const roughStep = maxValue / 4;
      const step = niceStep(roughStep);
      if(!(step > 0)) return [];
      const ticks = [];
      for(let value = 0; value <= maxValue + step * 0.5; value += step){
        ticks.push(Math.round(value));
      }
      return [...new Set(ticks)].filter(val => val >= 0).sort((a,b)=>a-b);
    }

    function niceStep(value){
      if(!(value > 0)) return 0;
      const exponent = Math.floor(Math.log10(value));
      const base = Math.pow(10, exponent);
      const fraction = value / base;
      let niceFraction;
      if(fraction <= 1) niceFraction = 1;
      else if(fraction <= 2) niceFraction = 2;
      else if(fraction <= 5) niceFraction = 5;
      else niceFraction = 10;
      return niceFraction * base;
    }

    function formatChartNumber(value){
      return NUMBER_FORMATTER.format(Math.round(value));
    }
    function scrollLeaveMatrixToCurrentWeeks(container, table){
      const headerRow = table.querySelector("thead tr:nth-child(3)");
      if(!headerRow) return;
      const headers = Array.from(headerRow.querySelectorAll("th[data-date]"));
      if(!headers.length) return;

      const today = todayUtc();
      const start = startOfISOWeek(today);
      const end = new Date(start);
      end.setUTCDate(end.getUTCDate() + 13);

      const startKey = formatISODate(start);
      let startCell = headers.find(th => th.dataset.date === startKey);
      if(!startCell){
        const startTime = start.getTime();
        startCell = headers.find(th => {
          const date = parseISODate(th.dataset.date);
          return date && date.getTime() >= startTime;
        });
      }
      if(!startCell) startCell = headers[0];

      const startIndex = headers.indexOf(startCell);
      const endKey = formatISODate(end);
      let endCell = headers.find(th => th.dataset.date === endKey);
      if(!endCell){
        const endTime = end.getTime();
        endCell = headers.find(th => {
          const date = parseISODate(th.dataset.date);
          return date && date.getTime() > start.getTime() && date.getTime() <= endTime;
        });
      }
      if(!endCell){
        const fallbackIndex = startIndex >= 0 ? Math.min(startIndex + 13, headers.length - 1) : headers.length - 1;
        endCell = headers[Math.max(0, fallbackIndex)];
      }

      const startLeft = startCell.offsetLeft;
      const endRight = endCell.offsetLeft + endCell.offsetWidth;
      const visibleWidth = container.clientWidth;
      const desiredWidth = endRight - startLeft;
      const margin = 20;
      let target = Math.max(0, startLeft - margin);

      if(desiredWidth > visibleWidth){
        target = Math.max(0, Math.min(startLeft, endRight - visibleWidth + margin));
      }

      container.scrollLeft = target;
    }

    function handleLeaveMatrixInput(event){
      const target = event.target;
      if(!target || !target.classList) return;
      if(target.classList.contains("leave-input")){
        const raw = String(target.value || "");
        const hasValue = raw.trim() !== "" && Number(raw) > 0;
        const reason = target.parentElement ? target.parentElement.querySelector(".leave-reason") : null;
        if(reason){
          reason.disabled = !hasValue;
          reason.classList.toggle("is-hidden", !hasValue);
        }
      }
    }

    function handleLeaveMatrixChange(event){
      const target = event.target;
      if(!target || !target.classList) return;
      if(target.classList.contains("leave-input")){
        onLeaveHoursChange(target);
      }else if(target.classList.contains("leave-reason")){
        onLeaveReasonChange(target);
      }
    }

    function onLeaveHoursChange(input){
      const empIndex = Number(input.dataset.emp);
      const date = input.dataset.date;
      if(!Number.isFinite(empIndex) || !date) return;
      const employee = getEmployeeByIndex(empIndex);
      if(!employee) return;
      if(!employee.entries) employee.entries = {};
      const entries = employee.entries;
      const raw = String(input.value || "").trim();
      if(!raw){
        delete entries[date];
        renderLeaveMatrix();
        return;
      }
      let hours = Number(raw);
      if(!Number.isFinite(hours) || hours <= 0){
        delete entries[date];
        renderLeaveMatrix();
        return;
      }
      hours = clampHours(employee, hours);
      input.value = formatHoursValue(hours);
      let entry = entries[date];
      if(!entry){
        entry = {};
        entries[date] = entry;
      }
      entry.hours = hours;
      const reasonSelect = input.parentElement ? input.parentElement.querySelector(".leave-reason") : null;
      const reasonValue = reasonSelect ? reasonSelect.value : "";
      if(reasonValue){
        entry.type = reasonValue;
      }else if(!entry.type){
        entry.type = LEAVE_TYPES[0].value;
      }
      entry.code = leaveCodeForType(entry.type);
      renderLeaveMatrix();
    }

    function onLeaveReasonChange(select){
      const empIndex = Number(select.dataset.emp);
      const date = select.dataset.date;
      if(!Number.isFinite(empIndex) || !date) return;
      const employee = getEmployeeByIndex(empIndex);
      if(!employee) return;
      if(!employee.entries) employee.entries = {};
      const entries = employee.entries;
      let entry = entries[date];
      const input = select.parentElement ? select.parentElement.querySelector(".leave-input") : null;
      const hours = input ? Number(input.value) : NaN;
      if(!entry){
        if(Number.isFinite(hours) && hours > 0){
          entry = {hours: clampHours(employee, hours)};
          entries[date] = entry;
        }else{
          return;
        }
      }
      entry.type = select.value || entry.type || LEAVE_TYPES[0].value;
      entry.code = leaveCodeForType(entry.type);
      if(Number.isFinite(hours) && hours > 0){
        entry.hours = clampHours(employee, hours);
      }
      renderLeaveMatrix();
    }

    function getEmployeeByIndex(index){
      const employees = state.leaveMatrix && Array.isArray(state.leaveMatrix.employees) ? state.leaveMatrix.employees : null;
      if(!employees) return null;
      return employees[index] || null;
    }

    // Drawer / Modal / Toast
    function openDrawer(){ document.getElementById("drawer").classList.add("open"); }
    function closeDrawer(){ document.getElementById("drawer").classList.remove("open"); }
    function openModal(id){ document.getElementById("modal-"+id).classList.add("show"); }
    function closeModal(id){ document.getElementById("modal-"+id).classList.remove("show"); }
    function toast(msg){ const t=document.getElementById("toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"), 1600); }

    // CRUD (demo)
    function saveTask(){
      const t = {
        id: "O-" + Math.floor(10000 + Math.random()*90000),
        title: document.getElementById("t-title").value.trim() || "Nieuwe taak",
        workshop_id: Number(document.getElementById("t-ws").value||1),
        skill: document.getElementById("t-skill").value.trim(),
        hours: Number(document.getElementById("t-hours").value||0),
        due_date: document.getElementById("t-due").value || "",
        priority: document.getElementById("t-prio").value || "Normaal",
        status: document.getElementById("t-status").value || "Open",
      };
      state.tasks.unshift(t);
      state.tasksVersion += 1;
      invalidateFilteredTasks();
      renderAll();
      closeDrawer();
      toast("Taak opgeslagen");
      clearTask();
    }
    function clearTask(){
      ["t-title","t-skill","t-hours","t-due"].forEach(id=> document.getElementById(id).value = "");
      document.getElementById("t-prio").value = "Normaal";
      document.getElementById("t-status").value = "Open";
      document.getElementById("t-ws").value = state.workshops[0].id;
    }
    function editTask(id){
      const t = state.tasks.find(x=>x.id===id); if(!t) return;
      openDrawer();
      document.getElementById("t-title").value = t.title;
      document.getElementById("t-ws").value = t.workshop_id;
      document.getElementById("t-skill").value = t.skill||"";
      document.getElementById("t-hours").value = t.hours||0;
      document.getElementById("t-due").value = t.due_date||"";
      document.getElementById("t-prio").value = t.priority||"Normaal";
      document.getElementById("t-status").value = t.status||"Open";
    }

    // Export / Import
    function exportCSV(){
      const rows = [["Order","Titel","Vestiging","Skill","Uren","Deadline","Prioriteit","Status"]];
      const tasks = getFilteredTasks();
      tasks.forEach(t=> rows.push([t.id,t.title,workshopName(t.workshop_id),t.skill||"",(Number.isFinite(t.safeHours)?t.safeHours:t.hours)||0,t.due_date||"",t.priority||"",t.status||""]));
      const csv = rows.map(r => r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], {type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href=url; a.download="planning_export.csv"; a.click();
      URL.revokeObjectURL(url);
      toast("Export gereed");
    }

    async function handleImport(evt){
      const file = evt.target.files[0]; if(!file) return;
      const text = await file.text();
      try{
        const data = JSON.parse(text);
        if(Array.isArray(data)){
          state.tasks = data;
          state.tasksVersion += 1;
          invalidateFilteredTasks();
          renderAll();
          toast("JSON geÃ¯mporteerd");
          return;
        }
      }catch(_){}
      toast("Ondersteund nu JSON array (taken). CSV/XLSX mapping kan worden toegevoegd.");
    }
  </script>
</body>
</html>
